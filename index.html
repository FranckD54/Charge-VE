<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Charge VE</title>
<link rel="manifest" href="manifest.json">

<style>
:root {
  --bg:#ffffff; --txt:#000; --card:#f2f2f2;
  --ok:#2e7d32; --warn:#f9a825; --bad:#c62828;
}
@media (prefers-color-scheme: dark) {
  :root { --bg:#121212; --txt:#fff; --card:#1e1e1e; }
}
body {
  font-family:-apple-system;
  background:var(--bg); color:var(--txt);
  margin:20px;
}
h1{font-size:22px;}
.card{
  background:var(--card);
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}
input,select{width:100%;}
button{
  width:100%; padding:12px;
  font-size:16px; margin-top:10px;
}
.ok{color:var(--ok);}
.warn{color:var(--warn);}
.bad{color:var(--bad);}
nav button{width:49%;}
</style>
</head>

<body>

<h1>Charge VE</h1>

<nav>
<button onclick="show('simu')">Simulation</button>
<button onclick="show('param')">Paramètres</button>
</nav>

<div id="simu">

<div class="card">
<label>Véhicule</label>
<select id="vehicule"></select>
</div>

<div class="card">
<label>Charge actuelle : <b><span id="socNowVal">40</span>%</b></label>
<input type="range" min="0" max="100" value="40" id="socNow">

<label>Objectif : <b><span id="socTargetVal">80</span>%</b></label>
<input type="range" min="0" max="100" value="80" id="socTarget">
</div>

<div class="card">
<label>Ampérage VE : <b><span id="ampVal">24</span> A</b></label>
<input type="range" min="20" max="32" step="4" value="24" id="amp">
<small><span id="kwVal"></span> kW</small>
</div>

<div class="card">
<label>Lave-linge</label>
<input type="range" min="0" max="1" id="ll">
<label>Lave-vaisselle</label>
<input type="range" min="0" max="1" id="lv">
<label>Sèche-linge</label>
<input type="range" min="0" max="1" id="sl">
</div>

<div class="card">
<label>VMC</label>
<select id="vmc">
<option value="2">Ventilation seule</option>
<option value="3.6">Ventilation + ECS</option>
</select>
</div>

<div class="card">
<label>Stratégie</label>
<select id="strategy">
<option value="objectif">Atteindre l’objectif coûte que coûte</option>
<option value="reseau">Éviter toute limite réseau</option>
</select>
</div>

<button onclick="auto()">Recommandation automatique</button>

<div class="card" id="res"></div>

</div>

<div id="param" style="display:none">

<div class="card">
<h3>Véhicules</h3>
<label>Nom</label>
<input id="vname" value="VE principale">
<label>Batterie (kWh)</label>
<input id="vbatt" type="number" value="81">
<label>Puissance AC max (kW)</label>
<input id="vac" type="number" value="11">
<button onclick="saveVehicle()">Enregistrer</button>
</div>

<div class="card">
<h3>Appareils</h3>
<label>LL / LV (A pic)</label>
<input id="pll" type="number" value="14">
<label>Sèche-linge (A pic)</label>
<input id="psl" type="number" value="18">
<label>Conso fantôme (A)</label>
<input id="pf" type="number" value="0.7">
</div>

<div class="card">
<h3>Heures creuses</h3>
<label>HC nuit</label>
<input id="hc1" value="00:50-06:50">
<label>HC journée</label>
<input id="hc2" value="14:50-16:50">
</div>

<div class="card">
<h3>Réseau</h3>
<label>Limite sécurisée (A)</label>
<input id="limit" type="number" value="45">
<button onclick="saveParams()">Enregistrer paramètres</button>
</div>

</div>

<script>
let vehicles = JSON.parse(localStorage.vehicles ||
 '[{"name":"VE principale","batt":81,"ac":11}]');

function show(id){
  simu.style.display=id=="simu"?"block":"none";
  param.style.display=id=="param"?"block":"none";
}

function loadVehicles(){
  vehicule.innerHTML="";
  vehicles.forEach((v,i)=>{
    vehicule.innerHTML+=`<option value="${i}">${v.name}</option>`;
  });
}
loadVehicles();

function saveVehicle(){
  vehicles[0]={name:vname.value,batt:+vbatt.value,ac:+vac.value};
  localStorage.vehicles=JSON.stringify(vehicles);
  loadVehicles();
  alert("Véhicule enregistré");
}

function hcHours(){
  let total=0;
  [hc1.value,hc2.value].forEach(h=>{
    if(h){
      const [a,b]=h.split("-");
      const da=new Date("1970-1-1 "+a);
      const db=new Date("1970-1-1 "+b);
      total+=(db-da)/36e5;
    }
  });
  return total;
}

function calcTotal(a){
  return a
   + ll.value*pll.value
   + lv.value*pll.value
   + sl.value*psl.value
   + +vmc.value
   + +pf.value;
}

function auto(){
  const lim=+limit.value;
  const strat=strategy.value;
  const v=vehicles[vehicule.value];
  const need=(socTarget.value-socNow.value)/100*v.batt;
  const hours=hcHours();

  [32,28,24,20].forEach(a=>{
    const power=Math.min(v.ac,a*230/1000);
    const okCharge=(need/power)<=hours;
    const okNet=calcTotal(a)<=lim;

    if(strat=="objectif" && okCharge && okNet) amp.value=a;
    if(strat=="reseau" && okNet) amp.value=a;
  });
  display();
}

function display(){
  socNowVal.textContent=socNow.value;
  socTargetVal.textContent=socTarget.value;
  ampVal.textContent=amp.value;
  kwVal.textContent=(amp.value*230/1000).toFixed(1);

  const v=vehicles[vehicule.value];
  const need=(socTarget.value-socNow.value)/100*v.batt;
  const power=Math.min(v.ac,amp.value*230/1000);
  const time=need/power;
  const total=calcTotal(+amp.value);

  let cls="ok", msg="OK";
  if(total>limit.value && total<=limit.value+5){cls="warn";msg="Limite";}
  if(total>limit.value+5){cls="bad";msg="Disjonction probable";}

  res.className="card "+cls;
  res.innerHTML=`
${msg}<br>
À charger : ${need.toFixed(1)} kWh<br>
Temps estimé : ${time.toFixed(1)} h<br>
Intensité totale : ${total.toFixed(1)} A<br>
HC dispo : ${hcHours().toFixed(1)} h`;
}

["amp","ll","lv","sl","vmc","socNow","socTarget","vehicule","strategy"]
.forEach(id=>document.getElementById(id).oninput=display);

display();
</script>

</body>
</html>
